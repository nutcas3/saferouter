name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  cli-tests:
    name: CLI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cli/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run CLI tests
        working-directory: ./cli
        run: cargo test --verbose

  ner-tests:
    name: NER Service Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      - name: Set up Python
        run: uv python install 3.11
      
      - name: Install dependencies
        working-directory: ./services/ner-service
        run: uv sync
      
      - name: Run tests
        working-directory: ./services/ner-service
        run: uv run pytest --cov=. --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./services/ner-service/coverage.xml
          flags: ner-service

  proxy-tests:
    name: Proxy Service Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      
      - name: Run tests
        working-directory: ./services/proxy
        run: go test -v -cover ./...

  vault-tests:
    name: Vault Service Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            services/vault/target
          key: ${{ runner.os }}-cargo-vault-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run tests
        working-directory: ./services/vault
        run: cargo test --verbose

  dashboard-build:
    name: Dashboard Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      
      - name: Install dependencies
        working-directory: ./services/dashboard
        run: bun install --frozen-lockfile
      
      - name: Build
        working-directory: ./services/dashboard
        run: bun run build
      
      - name: Check build output
        run: |
          if [ ! -d "services/dashboard/dist" ]; then
            echo "Build failed - dist directory not found"
            exit 1
          fi

  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [cli-tests, ner-tests, proxy-tests, vault-tests, dashboard-build]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build all services
        run: docker compose build
      
      - name: Test services startup
        run: |
          docker compose up -d
          sleep 30
          docker compose ps
          docker compose logs
          docker compose down -v
